import{b as K}from"./BLRsUYzB.js";import{a as Y}from"./B_qkIv1B.js";import{bt as X}from"./CJ_CGJpm.js";const R=Y().API_FINSC,m=()=>`${R}/order-service/${v().current_broker}`,v=()=>{const{auth:t}=K();return t},F=t=>{const{setAuth:e}=K();e({...t})},V=()=>JSON.parse(localStorage.getItem("tradingHandle")),k=t=>{const e={"Content-Type":"application/json",Authorization:"Bearer "+v().token};return t&&(e["trading-token"]=v().trading_token),e},O=t=>({"Cannot place order on aom halted symbol":"Không thể đặt lệnh trong phiên GD thỏa thuận","Ordered successfully":"Gửi lệnh thành công","Trade quantity not enough":"Không đủ cổ phiếu để đặt lệnh","Quantity is invalid":"Khối lượng không hợp lệ","quantity is required":"Khối lượng không được để trống","Cannot place order with that order type on BEGIN OF DAY session":"Không thể đặt loại lệnh này ngoài phiên GD","deal not found":"Bạn không sở hữu cổ phiếu này","Cannot place order on this session":"Hiện tại chưa cho phép đặt lệnh trước, chờ sau 20h","Price must be greater than or equal to floor price":"Giá đặt phải lớn hơn hoặc bằng giá sàn","Price must be less than or equal to ceiling price":"Giá đặt phải nhỏ hơn hoặc bằng giá trần"})[t]||"Lỗi không xác định",W=t=>{const e=new Date;return e.setDate(e.getDate()+t),e.toISOString().split("T")[0]},G=()=>localStorage.getItem("symbolLocal").replace(/"/g,""),rt=async(t,e)=>{const o=`${m()}/accounts/${v().account_no}/ppse?symbol=${t}&price=${e}`,s=await _(o,k());if((s==null?void 0:s.status)===!0)return s.data},J=()=>1769,it=async()=>{const t=`${m()}/orders?account=${v().account_no}`,e=await _(t,k());return(e==null?void 0:e.status)===!0?e.data:[]},at=async()=>{const t=`${m()}/conditional_order/orders?trading-token=${v().trading_token}`,e=await _(t,k());return(e==null?void 0:e.status)===!0?e.data:[]},lt=async t=>{const e=`${m()}/orders/${t}?account=${v().account_no}`;return await P(e,"DELETE",k(!0),{})},dt=async t=>{const e=`${m()}/conditional_order/orders/${t}?trading-token=${v().trading_token}`;return await P(e,"PATCH",k(!0),{})},Z=async()=>{const t=`${m()}/orders?account=${v().account_no}`,e=await _(t,k());if(e.status===!0)return e.data},A=async(t,e,o,s,n)=>{const c={symbol:t,side:e,orderType:o,price:s,quantity:n,loanPackageId:J(),accountNo:v().account_no};return await E(`${m()}/orders`,k(!0),c)},tt=async(t,e,o)=>{const s=await Z();console.log("limitOrderList",s),Object.keys(o).forEach(n=>{o[n].remove(),delete o[n]}),s.forEach(n=>{if(n.symbol!==G()||n.orderStatus!=="New")return;const c=n.side==="NB"?b().greenSC:b().redSC,i=t.activeChart().createOrderLine().setText(n.orderType+" "+n.price/1e3).setLineLength(1).setQuantity(n.quantity).setPrice(n.price/1e3).setLineColor(c).setBodyBorderColor(c).setBodyTextColor(c).setQuantityBorderColor(c).setQuantityBackgroundColor(c).setCancelButtonBorderColor(c).setCancelButtonIconColor(c).setBodyBackgroundColor(b().bgcls).setCancelButtonBackgroundColor(b().bgcls).setCancelTooltip("Đóng lệnh chờ").setModifyTooltip("Nhấp để chỉnh sửa khối lượng").setTooltip("Kéo thả để chỉnh sửa lệnh");i.onMove(function(){console.log("Order moved event");const l=this.getPrice().toFixed(1),r=JSON.parse(localStorage.getItem("ohlc")||"null"),u=l>r.close?1:0,h={rq:"changedk",id:n.id,macp:n.symbol,sldat:n.quantity,gdat:l,type:n.orderType,vitri:u};console.log(h),fajax_new("autotrade/tradedk",h,function(y){console.log(y),getsl()})}),i.onModify(function(l){console.log("Order modify event");const r=JSON.parse(localStorage.getItem("ohlc")||"null"),u=n.price>r.close?1:0;let h=document.querySelector(".order-quant").value;h=parseFloat(h.replace(/,/g,""));const y={rq:"changedk",id:n.id,macp:n.symbol,sldat:h,gdat:n.price,type:n.orderType,vitri:u};console.log(y),fajax_new("autotrade/tradedk",y,function(p){console.log(p),getsl()})}),i.onCancel(function(l){const r={title:"Xác nhận lệnh",body:"Đóng lệnh chờ này?",callback:u=>{u&&(console.log("dkTruocCancel",o),delete o[n.id],this.remove(),console.log("dkSauCancel",o),console.log("Order cancel event"))}};t.showConfirmDialog(r)}),o[n.id]=i})},T=async(t,e,o,s,n,c)=>{const i={condition:`${e}${n}`,targetOrder:{quantity:c,side:o,loanPackageId:J(),orderType:s},symbol:t,props:{stopPrice:n,marketId:"UNDERLYING"},accountNo:v().account_no,category:"STOP",timeInForce:{expireTime:`${W(30)}T07:30:00.000Z`,kind:"GTD"}};return await E(`${m()}/conditional_order/orders`,k(!0),i)},et=async()=>{const t=`${m()}/conditional_order/orders?accountNo=${v().account_no}&status=NEW&symbol=${G()}`,e=await _(t,k());if(e.status===!0)return e.data},D=async t=>await P(`${m()}/conditional_order/orders/${t}`,"PATCH",k(!0),{}),b=()=>({goldSC:"#e6ac00",greenSC:"#1fbb96",redSC:"#f93d4c",blueSC:"#2679c5",bgcls:"#161a2554",dmclsUp:"#02e5a6"}),L=async(t,e,o)=>{const s=await et();console.log("stopOrderList",s),console.log("stopOrderLines_before",o),Object.keys(o).forEach(n=>{o[n].remove(),delete o[n]}),console.log("stopOrderLines_after",o),s.content.forEach(n=>{const c=n.targetOrder.side==="NB"?b().greenSC:b().redSC,i=t.activeChart().createOrderLine().setText(n.targetOrder.orderType+" "+n.props.stopPrice/1e3).setLineLength(1).setQuantity(n.targetOrder.quantity).setPrice(n.props.stopPrice/1e3).setLineColor(c).setBodyBorderColor(c).setBodyTextColor(c).setQuantityBorderColor(c).setQuantityBackgroundColor(c).setCancelButtonBorderColor(c).setCancelButtonIconColor(c).setBodyBackgroundColor(b().bgcls).setCancelButtonBackgroundColor(b().bgcls).setCancelTooltip("Đóng lệnh chờ").setModifyTooltip("Nhấp để chỉnh sửa khối lượng").setTooltip("Kéo thả để chỉnh sửa lệnh");i.onMove(async function(){console.log("Order move event");const l=this.getPrice().toFixed(1),r=l>e.dataSI.matchPrice?"price >= ":"price <= ";await D(n.id),await T(n.symbol,r,n.targetOrder.side,n.targetOrder.orderType,l*1e3,n.targetOrder.quantity),L(t,e,o)}),i.onModify(async function(l){console.log("Order modify event");let r=V().quantIn||0;await D(n.id),await T(n.symbol,n.condition,n.targetOrder.side,n.targetOrder.orderType,n.targetOrder.price,r),L(t,e,o)}),i.onCancel(function(l){console.log("Order cancel event");const r={title:"Xác nhận lệnh",body:"Đóng lệnh chờ này?",callback:async u=>{u&&(console.log("dkSauCancel",o),await D(n.id),L(t,e,o))}};t.showConfirmDialog(r)}),o[n.id]=i})};var Q={},nt={};const ut=(t,e)=>{t.onContextMenu(function(o,s){console.log(e.dataSI.matchPrice);const n=e.dataSI.matchPrice;let c=s>n?" khi Giá >":" khi Giá <";const i=s>n?"price >= ":"price <= ";s=parseFloat(s.toFixed(1));let l=V().quantIn||0;const r=G();let u=l.toLocaleString("en-US"),h="BuyStop +"+u+" "+r+c+s,y="SellStop -"+u+" "+r+c+s,p="BuyLimit +"+u+" "+r+" Giá "+s,d="SellLimit -"+u+" "+r+" Giá "+s;return[{position:"top",text:p,click:async function(){const g=await A(r,"BUY","LO",s*1e3,l);t.showNoticeDialog({title:"Thông báo",body:`${O(g.message)}!
Chi tiết: ${p}`}),tt(t,e,nt)}},{position:"top",text:d,click:async function(){const g=await A(r,"SELL","LO",s*1e3,l);t.showNoticeDialog({title:"Thông báo",body:`${O(g.message)}!
Chi tiết: ${d}`})}},{text:"-",position:"top"},{position:"top",text:h,click:async function(){const g=await T(r,i,"NB","MP",s*1e3,l);t.showNoticeDialog({title:"Thông báo",body:`${O(g.message)}!
Chi tiết: ${h}`}),L(t,e,Q)}},{position:"top",text:y,click:async function(){const g=await T(r,i,"NS","MP",s*1e3,l);t.showNoticeDialog({title:"Thông báo",body:`${O(g.message)}!
Chi tiết: ${y}`}),L(t,e,Q)}},{text:"-",position:"top"}]})},gt=()=>{var t=document.createElement("div");t.classList.add("dialog-popup"),t.id="TV-popup";var e='<div class="logtrade"><h3>Kết nối tài khoản chứng khoán</h3><div class="broker-list"><label><img src="/static/tv/logo-broker/logo-vnds.svg"></label><input type="radio" name="broker" value="vnds" title="Công ty cổ phần chứng khoán VNDIRECT"><label><img src="/static/tv/logo-broker/logo-ssi.svg"></label><input type="radio" name="broker" value="ssi" title="Công ty cổ phần chứng khoán SSI"><label><img src="/static/tv/logo-broker/logo-dnse.svg"></label><input type="radio" name="broker" value="dnse" title="Công ty cổ phần chứng khoán DNSE"><label><img src="/static/tv/logo-broker/logo-vps.svg"></label><input type="radio" name="broker" value="vps" title="Công ty cổ phần chứng khoán VPS"><label><img src="/static/tv/logo-broker/logo-tcbs.svg"></label><input type="radio" name="broker" value="tcbs" title="Công ty cổ phần chứng khoán Kỹ thương"></div><div class="broker"><img class="minhhoa" src="/static/tv/svg-minhhoa/choose.svg"><div class="tbao">Chọn một trong các đối tác của chúng tôi</div></div></div>';t.innerHTML=e,document.body.appendChild(t);const o=document.querySelectorAll('input[name="broker"]'),s=document.querySelector(".broker");o.forEach(n=>{n.addEventListener("click",function(c){let i='<div class="inputBox"><input id="usertrade" type="text" required="required"><img src="/static/feather/user.svg"><span>Tên đăng nhập</span></div><div class="inputBox"><input id="passtrade" type="password" required="required"><img src="/static/feather/lock.svg"><span>Mật khẩu</span></div><div class="inputBox otp hide_sc"><input id="otptrade" type="otp" required="required"><img src="/static/feather/key.svg"><span>OTP</span></div>';switch(n.value){case"vnds":let l=i+'<div id="noti-lgt"></div><div class="inputBox lg2"><button id="enter-vndirect" type="submit">Gửi OTP SMS</button></div>';s.innerHTML=l,j("#enter-vndirect","VNDS",t);break;case"dnse":let r=i+'<div class="otp-options"><label><input type="radio" name="otp-method" value="email"> Email OTP</label><label><input type="radio" name="otp-method" value="smart" checked> Smart OTP</label></div><div id="noti-lgt"></div><div class="inputBox lg2"><button id="enter-dnse" type="submit">Đăng nhập</button></div>';s.innerHTML=r,j("#enter-dnse","DNSE",t);break;case"ssi":case"vps":case"tcbs":let u='<div class="pyramid"> <span class="soon">SẮP RA MẮT</span> <div class="tv-shadow"></div> <div> <span style="--i:0;"></span> <span style="--i:1;"></span> <span style="--i:2;"></span> <span style="--i:3;"></span> </div></div>';s.innerHTML=u;break}})}),t.addEventListener("click",function(n){n.target===t&&t.remove()}),t.style.display="block"},j=(t,e,o)=>{const s=X();document.querySelector(t).addEventListener("click",async function(){const c=document.getElementById("usertrade").value,i=document.getElementById("passtrade").value,r=new Date().getTime(),u={username:c,password:i},h={"Content-Type":"application/json"};await E(`${R}/order-service/${e}/login`,h,u,async function(y){const p=document.getElementById("noti-lgt");if(y.message==="Authenticated successfully"){let d=y.data;d.current_broker=e,d.login_time=r,F(d);let g=e==="DNSE"?'<div class="sc-success">Đăng nhập thành công, tiếp tục xác thực OTP</div>':'<div class="sc-success">Gửi OTP thành công, kiểm tra tin nhắn</div>';p.innerHTML=g;const N=document.querySelector(".inputBox.lg2");N.innerHTML='<button id="enter-otp" type="submit">Kết nối</button>';const M=document.querySelector(".inputBox.otp");M.style.display="block";const w={"Content-Type":"application/json",Authorization:"Bearer "+d.token};await _(`${m()}/accounts`,w,function(f){f.message==="Fetched user information successfully"&&(d.account_no=f.data.default.id,d.name=f.data.default.name,console.log(d),F(d))});const q=document.querySelector('input[name="otp-method"]:checked').value;q==="email"&&await _(`${m()}/otp`,w,function(f){if(f.message==="Sent email otp successfully"){const C='<div class="sc-success">Gửi OTP thành công, kiểm tra email</div>';p.innerHTML=C}else{const C='<div class="sc-fail">Gửi OTP thất bại</div>';p.innerHTML=C}}),document.getElementById("enter-otp").addEventListener("click",async function(){const f=document.getElementById("otptrade").value,$={"Content-Type":"application/json",Authorization:"Bearer "+v().token,...q==="email"?{otp:f}:{"smart-otp":f}};await E(`${m()}/trading-token`,$,null,function(x){if(x.message==="Fetched trading token successfully"){d.trading_token=x.data.trading_token,console.log(d),F(d);const B='<div class="sc-success">Kết nối thành công</div>';p.innerHTML=B,o.remove(),console.log({title:"Thông báo",body:"Kết nối thành công"}),s.add({title:"Đăng nhập thành công",description:"",icon:"i-ri-check-double-line"})}else{const B='<div class="sc-fail">Sai OTP, hãy nhập lại</div>';p.innerHTML=B}})})}else{const d='<div class="sc-fail">Sai tên đăng nhập hoặc mật khẩu</div>';p.innerHTML=d}})})};async function E(t,e,o,s=null){try{const n=await fetch(t,{method:"POST",headers:e,body:JSON.stringify(o)});if(!n.ok)throw new Error("Network response was not ok");const c=await n.json();if(s)s(c);else return c}catch(n){if(console.error(n),s)s(null);else return null}}async function _(t,e,o=null){try{const s=await fetch(t,{method:"GET",headers:e});if(!s.ok)throw new Error("Network response was not ok");const n=await s.json();if(o)o(n);else return n}catch(s){if(console.error(s),o)o(null);else return null}}async function P(t,e,o,s,n=null){try{const c=await fetch(t,{method:e,headers:o,body:JSON.stringify(s)});if(!c.ok)throw new Error("Network response was not ok");const i=await c.json();if(n)n(i);else return i}catch(c){if(console.error(c),n)n(null);else return null}}const pt=t=>{t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");const o=new RegExp("[\\?&]"+t+"=([^&#]*)").exec(window.location.search);return o===null?"":decodeURIComponent(o[1].replace(/\+/g," "))},ht=(t={},e={})=>{var C,$,x,B;const{basicPrice:o=0,matchPrice:s=0,matchQtty:n=0}=t,c=Math.max(n*10,...((C=e==null?void 0:e.bid)==null?void 0:C.map(a=>a.qtty*10))||[],...(($=e==null?void 0:e.ask)==null?void 0:$.map(a=>a.qtty*10))||[]),i=(a,S)=>{const I=c?S*10/c*100:0,U=o?((a-o)/o*100).toFixed(1):"0.0",z=a-o;return{changedRatio:U,percentChange:I.toFixed(1),changed:z.toFixed(2)}},l=((x=e==null?void 0:e.bid)==null?void 0:x.map(a=>({price:a.price,qtty:(a.qtty*10).toLocaleString(),...i(a.price,a.qtty)})))||[],r=((B=e==null?void 0:e.ask)==null?void 0:B.map(a=>({price:a.price,qtty:(a.qtty*10).toLocaleString(),...i(a.price,a.qtty)})))||[],u={price:s,qtty:(n*10).toLocaleString(),...i(s,n)},h=[...l,...r].sort((a,S)=>(S==null?void 0:S.price)-(a==null?void 0:a.price));h.splice(3,0,u);const y=a=>!a||a.length===0?0:a.reduce((S,I)=>S+I.qtty*10,0),p=y(e==null?void 0:e.ask),d=y(e==null?void 0:e.bid),g=p+d,N=g?(p/g*100).toFixed(6):"0.0",M=g?(d/g*100).toFixed(6):"0.0",w=t.buyForeignQtty||0,q=t.sellForeignQtty||0,H=g?(w/g*100).toFixed(1):"0.0",f=g?(q/g*100).toFixed(1):"0.0";return{bids:l,asks:r,matchData:u,list:h,sumBuy:p,sumSell:d,sumBuyPercentage:N,sumSellPercentage:M,buyForeign:w,sellForeign:q,buyForeignPercentage:H,sellForeignPercentage:f}};function yt(t,e=!1){if(e){const o=new Date;console.log(`${o.toLocaleTimeString()}.${o.getMilliseconds()}> ${t}`)}}function mt(t){return t===void 0?"":typeof t=="string"?t:t.message}export{T as a,A as b,at as c,it as d,dt as e,lt as f,R as g,ht as h,pt as i,mt as j,yt as k,gt as l,W as m,G as n,V as o,ut as p,L as q,O as r,Q as s,rt as t};
