import{D as g,a as p}from"./C49mzbbv.js";function u(c){return c===void 0?"":typeof c=="string"?c:c.message}class b{constructor(e={}){this._headers=e}_createUrlPath(e,s){if(s&&Object.keys(s).length>0){const t=Object.entries(s).map(([r,a])=>`${encodeURIComponent(r)}=${encodeURIComponent(a)}`).join("&");return`${e}?${t}`}return e}async sendRequest(e,s,t){const r=this._createUrlPath(s,t),a={credentials:"same-origin",headers:this._headers};try{const o=await(await fetch(`${e}/${r}`,a)).text();return JSON.parse(o)}catch(i){throw console.error("Error during GET request:",i),i}}async sendRequestPost(e,s,t){const r=this._createUrlPath(s,t),a={method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json",...this._headers},body:JSON.stringify(t)};try{const o=await(await fetch(`${e}/${r}`,a)).text();return JSON.parse(o)}catch(i){throw console.error("Error during POST request:",i),i}}}class v{constructor(e,s,t){this._datafeedUrl=e,this._datafeedUrl3="https://app.finsc.vn/api/v1",this._requester=s,this._limitedServerResponse=t,this._limitCall=0}getBars(e,s,t){const a={1:1,60:"1H","1D":"1D",W:"1W"}[s]||s;let i={symbol:e.ticker||"",resolution:a,start:t.from,end:t.to};const o=["VNINDEX","VN30","HNX","HNX30"],l=["VN30F1M","VN30F2M","VN30F1Q","VN30F2Q"];let d=o.includes(i.symbol)?"index":l.includes(i.symbol)?"derivative":"stock",h=this._datafeedUrl3;return e.ticker.includes("#")&&(h=this._datafeedUrl,d="history"),d==="history"&&(i.resolution=s),t.countBack!==void 0&&(i.countback=t.countBack),e.currency_code!==void 0&&(i.currencyCode=e.currency_code),e.unit_id!==void 0&&(i.unitId=e.unit_id),new Promise(async(m,y)=>{try{const f=await this._requester.sendRequest(h,d,i),_=this._processHistoryResponse(f,i);this._limitedServerResponse&&await this._processTruncatedResponse(_,i),m(_)}catch(f){const _=u(f);console.warn(`HistoryProvider: getBars() failed, error=${_}`),y(_)}})}async _processTruncatedResponse(e,s){let t=e.bars.length;try{for(;this._limitedServerResponse&&this._limitedServerResponse.maxResponseLength>0&&this._limitedServerResponse.maxResponseLength===t&&s.start<s.end;){s.countback&&(s.countback-=t),s.start=this._limitedServerResponse.expectedOrder==="earliestFirst"?Math.round(e.bars[e.bars.length-1].time/1e3):s.start,s.end=this._limitedServerResponse.expectedOrder==="earliestFirst"?s.end:Math.round(e.bars[0].time/1e3);const r=await this._requester.sendRequest(urlX,type,s),a=this._processHistoryResponse(r);t=a.bars.length,this._limitedServerResponse.expectedOrder==="earliestFirst"?(a.bars[0].time===e.bars[e.bars.length-1].time&&a.bars.shift(),e.bars.push(...a.bars)):(a.bars[a.bars.length-1].time===e.bars[0].time&&a.bars.pop(),e.bars.unshift(...a.bars))}}catch(r){const a=u(r);console.warn(`HistoryProvider: getBars() warning during followup request, error=${a}`)}}_processHistoryResponse(e,s){const t=[],r={noData:!1};if(e.s==="no_data"||e.t.length===0||e.t===null)r.noData=!0,r.nextTime=this._limitCall<=4?e.nextTime||S(s.start):!1,this._limitCall+=1;else{const a=e.v!==void 0,i=e.o!==void 0;for(let o=0;o<e.t.length;++o){const l={time:e.t[o]*1e3,close:parseFloat(e.c[o]),open:parseFloat(i?e.o[o]:e.c[o]),high:parseFloat(i?e.h[o]:e.c[o]),low:parseFloat(i?e.l[o]:e.c[o])};a&&(l.volume=parseFloat(e.v[o])),t.push(l)}}return{bars:t,meta:r}}}function S(c){const e=new Date(c);return e.setDate(e.getDate()+5),e.getTime()}const R="/static/tv/data/symbol.json";function n(c,e,s){const t=c[e];return Array.isArray(t)?t[s]:t}const w={supports_search:!1,supports_group_request:!0,supports_marks:!1,supports_timescale_marks:!1,supports_time:!1,exchanges:[{value:"",name:"All Exchanges",desc:""},{value:"HNX",name:"HNX",desc:"Sàn HNX"},{value:"HOSE",name:"HOSE",desc:"Sàn HOSE"},{value:"UPCOM",name:"UPCOM",desc:"Sàn UPCOM"},{value:"OTHER",name:"OTHER",desc:"Ngành"}],symbols_types:[{name:"All types",value:""},{name:"Stock",value:"stock"},{name:"Index",value:"index"}],supported_resolutions:["1","3","5","15","30","60","120","D","W","M"],intraday_multipliers:["1","60"]};class C{constructor(e,s=10*1e3,t){this._configuration=k(),this._datafeedURL=e,this._requester=new b,this._historyProvider=new v(e,this._requester,t),this._dataPulseProvider=new g(this._historyProvider,s),this._dataPulseProviderRealtime=new p(this._historyProvider),this._allsymbols=[],this.getAllSymbols()}onReady(e){setTimeout(()=>e(this._configuration))}async getAllSymbols(){try{const s=await(await fetch(R)).json();this._allsymbols=s}catch(e){`${u(e)}`}}async searchSymbols(e,s,t,r){if(this._configuration.supports_search){const a={limit:30,query:e.toUpperCase(),type:t,exchange:s};this._send("search",a).then(i=>{if(i.s!==void 0){`${i.errmsg}`,r([]);return}r(i)}).catch(i=>{`${e}${u(i)}`,r([])})}else{const a=this._allsymbols.filter(i=>i.symbol.toLowerCase().includes(e.toLowerCase()));r(a)}}async resolveSymbol(e,s,t,r){const a=r==null?void 0:r.currencyCode,i=r==null?void 0:r.unitId,o=l=>{setTimeout(()=>s(l))};if(this._configuration.supports_group_request){const l=e.split("#")[0],d=this._allsymbols.find(({symbol:m})=>m===l);if(!d){console.log("[resolveSymbol]: Cannot resolve symbol",e),t("cannot resolve symbol");return}const h=this._constructSymbolInfo(e,d);console.log("[resolveSymbol]: Symbol resolved",e),o(h)}else{const l={symbol:e,...a&&{currencyCode:a},...i&&{unitId:i}};this._send("symbols",l).then(d=>{if(d.s!==void 0)t("unknown_symbol");else{const h=this._processResolvedSymbol(d);o(h)}}).catch(d=>{`${u(d)}`,t("unknown_symbol")})}}_processResolvedSymbol(e){return{name:e.name,listed_exchange:e.listed_exchange||e["exchange-listed"],exchange:e.exchange||e["exchange-traded"],ticker:e.ticker,currency_code:e.currency_code||e["currency-code"],original_currency_code:e.original_currency_code||e["original-currency-code"],unit_id:e.unit_id||e["unit-id"],original_unit_id:e.original_unit_id||e["original-unit-id"],unit_conversion_types:e.unit_conversion_types||e["unit-conversion-types"],has_intraday:e.has_intraday||e["has-intraday"]||!1,visible_plots_set:e.visible_plots_set||e["visible-plots-set"],minmov:e.minmovement||e.minmov||0,session:e.session||e["session-regular"],supported_resolutions:e.supported_resolutions||this._configuration.supported_resolutions,intraday_multipliers:e.intraday_multipliers||this._configuration.intraday_multipliers,volume_precision:e.volume_precision||e["volume-precision"],format:e.format||"price",has_daily:e.has_daily||e["has-daily"]||!0}}_constructSymbolInfo(e,s){return{name:e,base_name:[`${s.exchange}:${e}`],listed_exchange:s.exchange,exchange:s.exchange,ticker:e,symbol:e,description:s.description,type:s.type,session:"0900-1130,1300-1500",timezone:"Asia/Bangkok",minmov:1,minmov2:0,pricescale:100,pointvalue:1,has_daily:!0,has_intraday:!0,has_weekly_and_monthly:!1,supported_resolutions:this._configuration.supported_resolutions,intraday_multipliers:this._configuration.intraday_multipliers,volume_precision:2,data_status:"streaming"}}async getBars(e,s,t,r,a){try{const i=await this._historyProvider.getBars(e,s,t);r(i.bars,i.meta)}catch(i){a(i)}}subscribeBars(e,s,t,r){this._getType(e.ticker)==="index"?this._dataPulseProvider.subscribeBars(e,s,t,r):this._dataPulseProviderRealtime.subscribeBars(e,s,t,r)}unsubscribeBars(e){this._dataPulseProvider.unsubscribeBars(e),this._dataPulseProviderRealtime.unsubscribeBars(e)}getMarks(e,s,t,r,a){if(!this._configuration.supports_marks)return;const i={symbol:e.ticker||"",from:s,to:t,resolution:a};this._send("marks",i).then(o=>{const l=Array.isArray(o)?o:this._transformMarksResponse(o);r(l)}).catch(o=>{`${u(o)}`,r([])})}_transformMarksResponse(e){return e.id.map((s,t)=>({id:n(e,"id",t),time:n(e,"time",t),color:n(e,"color",t),text:n(e,"text",t),label:n(e,"label",t),labelFontColor:n(e,"labelFontColor",t),minSize:n(e,"minSize",t),borderWidth:n(e,"borderWidth",t),hoveredBorderWidth:n(e,"hoveredBorderWidth",t),imageUrl:n(e,"imageUrl",t),showLabelWhenImageLoaded:n(e,"showLabelWhenImageLoaded",t)}))}getTimescaleMarks(e,s,t,r,a){if(!this._configuration.supports_timescale_marks)return;const i={symbol:e.ticker||"",from:s,to:t,resolution:a};this._send("timescale_marks",i).then(o=>{const l=Array.isArray(o)?o:this._transformTimescaleMarksResponse(o);r(l)}).catch(o=>{`${u(o)}`,r([])})}_transformTimescaleMarksResponse(e){return e.id.map((s,t)=>({id:n(e,"id",t),time:n(e,"time",t),color:n(e,"color",t),label:n(e,"label",t),tooltip:n(e,"tooltip",t),imageUrl:n(e,"imageUrl",t),showLabelWhenImageLoaded:n(e,"showLabelWhenImageLoaded",t)}))}getServerTime(e){this._configuration.supports_time&&this._send("time").then(s=>{const t=parseInt(s);isNaN(t)||e(t)}).catch(s=>{`${u(s)}`})}_requestConfiguration(){return this._send("config").catch(e=>(`${u(e)}`,null))}_getType(e){const s=["VNINDEX","VN30","HNX","HNX30"],t=["VN30F1M","VN30F2M","VN30F1Q","VN30F2Q"];return s.includes(e)?"index":t.includes(e)?"derivative":"stock"}_send(e,s){return this._requester.sendRequest(this._datafeedURL,e,s)}_setupWithConfiguration(e){if(this._configuration=e,e.exchanges||(e.exchanges=[]),!e.supports_search&&!e.supports_group_request)throw new Error("Unsupported datafeed configuration. Must either support search, or support group request");(e.supports_group_request||!e.supports_search)&&(this._symbolsStorage=new SymbolsStorage(this._datafeedURL,e.supported_resolutions||[],this._requester)),`${JSON.stringify(e)}`}}function k(){return w}export{C as D};
