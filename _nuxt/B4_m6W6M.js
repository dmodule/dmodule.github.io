import{u as F,c as ie}from"./CvAXrM3X.js";import{u as ce}from"./C-6mcIHo.js";import{D as re,c as le}from"./CrGTrm09.js";import{b as E,a as de,t as ue,r as K,c as R,d as x,e as ge,f as pe}from"./CsUNmt0V.js";import{u as me,a_ as C,r as I,bb as ve,b3 as V,bs as he,bq as be}from"./C-UWfBKM.js";import"./CnbxAtif.js";import"./BHQX9Zn-.js";import"./DxqHYnwt.js";import"./BLVB0qGI.js";import"./DdDBkiWh.js";import"./BaGbu_iK.js";const xe={__name:"TradingviewFinsc",emits:["update:symbol"],setup(ye,{expose:G,emit:U}){const Y=U,{$colorMode:z}=me(),D=C(()=>z.value),k=I(null),w=I(null),O=I(null),{getProfile:X}=ce(),{sub:j}=X(),Q=j.split("|"),P=C(()=>Q[1]),{setDataSI:W,setDataTP:Z}=F(),_=ie("symbolLocal","FPT"),ee=v=>_.value=v,te=v=>{k.value.chart().setSymbol(v)},ne=v=>{var A,J;w.value=new re(E,5e3,{maxResponseLength:1e3,expectedOrder:"latestFirst"}),(A=le)==null||A.on("message",(t,e)=>{const a=JSON.parse(e);switch(t.split("/")[3]){case"TP":Z(a);break;case"SI":W(a);break;default:return}});var r=k.value=window.tvWidget=new TradingView.widget({theme:D.value,load_last_chart:!0,autosize:!1,width:"100%",height:"100%",symbol:_.value,interval:"1D",timezone:"Asia/Bangkok",container:v,datafeed:w.value,library_path:"/static/tv/charting_library/",locale:de("lang")||"en",custom_css_url:"/static/tv/themeTV.css",enabled_features:["study_templates"],charts_storage_url:E,client_id:P.value,user_id:P.value,auto_save_delay:10,charts_storage_api_version:"1.1",disabled_features:["popup_hints"]});function H(){var t=document.createElement("div");t.classList.add("dialog-popup"),t.id="TV-popup";var e='<div class="logtrade"><h3>Kết nối tài khoản chứng khoán</h3><div class="broker-list"><label><img src="/static/tv/logo-broker/logo-vnds.svg"></label><input type="radio" name="broker" value="vnds" title="Công ty cổ phần chứng khoán VNDIRECT"><label><img src="/static/tv/logo-broker/logo-ssi.svg"></label><input type="radio" name="broker" value="ssi" title="Công ty cổ phần chứng khoán SSI"><label><img src="/static/tv/logo-broker/logo-dnse.svg"></label><input type="radio" name="broker" value="dnse" title="Công ty cổ phần chứng khoán DNSE"><label><img src="/static/tv/logo-broker/logo-vps.svg"></label><input type="radio" name="broker" value="vps" title="Công ty cổ phần chứng khoán VPS"><label><img src="/static/tv/logo-broker/logo-tcbs.svg"></label><input type="radio" name="broker" value="tcbs" title="Công ty cổ phần chứng khoán Kỹ thương"></div><div class="broker"><img class="minhhoa" src="/static/tv/svg-minhhoa/choose.svg"><div class="tbao">Chọn một trong các đối tác của chúng tôi</div></div></div>';t.innerHTML=e,document.body.appendChild(t);const a=document.querySelectorAll('input[name="broker"]'),o=document.querySelector(".broker");a.forEach(i=>{i.addEventListener("click",function(c){let l='<div class="inputBox"><input id="usertrade" type="text" required="required"><img src="/static/feather/user.svg"><span>Tên đăng nhập</span></div><div class="inputBox"><input id="passtrade" type="password" required="required"><img src="/static/feather/lock.svg"><span>Mật khẩu</span></div><div class="inputBox otp hide_sc"><input id="otptrade" type="otp" required="required"><img src="/static/feather/key.svg"><span>OTP</span></div><div id="noti-lgt"></div><div class="inputBox lg2">';switch(i.value){case"vnds":let d=l+'<button id="enter-vndirect" type="submit">Gửi OTP SMS</button></div>';o.innerHTML=d,N("#enter-vndirect","VND",t);break;case"dnse":let b=l+'<button id="enter-dnse" type="submit">Đăng nhập</button></div>';o.innerHTML=b,N("#enter-dnse","DNSE",t);break;case"ssi":case"vps":case"tcbs":let h='<div class="pyramid"> <span class="soon">SẮP RA MẮT</span> <div class="tv-shadow"></div> <div> <span style="--i:0;"></span> <span style="--i:1;"></span> <span style="--i:2;"></span> <span style="--i:3;"></span> </div></div>';o.innerHTML=h;break}})}),t.addEventListener("click",function(i){i.target===t&&t.remove()}),t.style.display="block"}function N(t,e,a){document.querySelector(t).addEventListener("click",async function(){const i=document.getElementById("usertrade").value,c=document.getElementById("passtrade").value,d=new Date().getTime(),b={username:i,password:c},h={"Content-Type":"application/json"};await K(`${E}/order-service/${e}/login`,h,b,async function(T){const u=document.getElementById("noti-lgt");if(T.message==="Authenticated successfully"){let n=T.data;n.current_broker=e,n.login_time=d,localStorage.setItem("auth",JSON.stringify(n));let S=e==="DNSE"?'<div class="sc-success">Đăng nhập thành công, đang gửi OTP</div>':'<div class="sc-success">Gửi OTP thành công, kiểm tra tin nhắn</div>';u.innerHTML=S;const y=document.querySelector(".inputBox.lg2");y.innerHTML='<button id="enter-otp" type="submit">Kết nối</button>';const q=document.querySelector(".inputBox.otp");q.style.display="block";const L={"Content-Type":"application/json",Authorization:"Bearer "+n.token};await R(`${x()}/accounts`,L,function(g){g.message==="Fetched user information successfully"&&(n.account_no=g.data.default.id,n.name=g.data.default.name,localStorage.setItem("auth",JSON.stringify(n)))}),await R(`${x()}/otp`,L,function(g){if(g.message==="Sent email otp successfully"){const s='<div class="sc-success">Gửi OTP thành công, kiểm tra email</div>';u.innerHTML=s}else{const s='<div class="sc-fail">Gửi OTP thất bại</div>';u.innerHTML=s}}),document.getElementById("enter-otp").addEventListener("click",async function(){const g=document.getElementById("otptrade").value,p={"Content-Type":"application/json",Authorization:"Bearer "+JSON.parse(localStorage.getItem("auth")).token,otp:g};await K(`${x()}/trading-token`,p,null,function(m){if(m.message==="Fetched trading token successfully"){n.trading_token=m.data.trading_token,console.log(n),localStorage.setItem("auth",JSON.stringify(n));const f='<div class="sc-success">Kết nối thành công</div>';u.innerHTML=f,a.remove();const M={title:"Thông báo",body:"Kết nối thành công"};r.showNoticeDialog(M)}else{const f='<div class="sc-fail">Sai OTP, hãy nhập OTP nhận từ email</div>';u.innerHTML=f}})})}else{const n='<div class="sc-fail">Sai tên đăng nhập hoặc mật khẩu</div>';u.innerHTML=n}})})}function se(e){var e=document.querySelector(e);let a=!1,o,i;e.addEventListener("mousedown",function(c){a=!0,o=c.clientX-e.getBoundingClientRect().left,i=c.clientY-e.getBoundingClientRect().top;const l=document.createElement("div");l.classList.add("coverResize"),document.body.appendChild(l);function d(h){a&&(e.style.left=`${h.clientX-o}px`,e.style.top=`${h.clientY-i}px`)}function b(){a=!1,document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",b),l.remove()}document.addEventListener("mousemove",d),document.addEventListener("mouseup",b)})}function B(){return localStorage.getItem("symbolLocal").replace(/"/g,"")}k.value.headerReady().then(()=>{var t=r.createButton({align:"right"});t.setAttribute("title","Tắt/Mở kết nối giao dịch"),t.innerHTML='<div class="item-headbar"><label class="toggle"> <input class="toggle-checkbox" type="checkbox"> <div class="toggle-switch"></div> <span class="toggle-label">Giao dịch</span> </label></div>';const e=t.querySelector(".toggle-checkbox");var a=r.createButton({align:"right"});a.setAttribute("title","Kết nối tài khoản chứng khoán"),a.innerHTML='<div class="item-headbar"><div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M17.31 8.25h-4.5l1.66-5.07a.94.94 0 0 0-.9-1.18H7.93a.94.94 0 0 0-.93.81L5.76 12.2a.94.94 0 0 0 .93 1.06h4.63l-1.8 7.6a.94.94 0 0 0 1.73.68l6.87-11.87a.94.94 0 0 0-.8-1.41Z"></path></svg></div><div>Kết nối</div></div>',a.addEventListener("click",function(){H()});var o=document.createElement("div");o.classList.add("ordercase-cover"),o.innerHTML=`<div class="ordercase"> 
						<button class="order-sellmp">BÁN MP</button> 
						<div> 
							<div class="order-sym-cover">
								<div class="order-sym"></div>
							</div>
							<div class="quant-case"> 
								<input class="order-quant" type="text" value="">
								<input class="order-ppse" style="display: none" type="text" value="" readonly> 
							</div>
						</div> 
						<button class="order-buymp">MUA MP</button> 
					</div>`,document.body.appendChild(o),se(".ordercase"),console.log(JSON.parse(localStorage.getItem("auth")));const i=JSON.parse(localStorage.getItem("tradingHandle"));let c=i||{};e.addEventListener("change",function(){if(c.updateTime=new Date().getTime(),this.checked){const l=JSON.parse(localStorage.getItem("auth")),d=l?l.login_time:null,h=new Date().getTime()-d,T=8*60*60*1e3;if(h<=T){c.status="active",localStorage.setItem("tradingHandle",JSON.stringify(c)),o.style.display="block";const u=document.querySelector(".order-sym"),n=document.querySelector(".quant-case"),S=n.querySelector(".order-ppse"),y=document.querySelector(".order-quant");u.innerHTML=B(),y.value=i?i.quantIn:0,n.addEventListener("focusin",()=>{S.style.display="block"}),n.addEventListener("focusout",()=>{S.style.display="none"}),y.addEventListener("click",async function(){const s=F(),p=C(()=>s.dataSI),m=await ue(B(),p.value.ceilingPrice*1e3);m?S.value=m.qmax.toLocaleString("en-US"):S.value="..."}),y.addEventListener("blur",function(){let s=y.value;if(s=parseFloat(s.replace(/,/g,"")),c.quantIn=s,localStorage.setItem("tradingHandle",JSON.stringify(c)),s%100!==0){this.value=100;const p={title:"Khối lượng không hợp lệ",body:"Nhập lô chẵn (100, 300, 1500, 2000,...) cổ phiếu"};r.showNoticeDialog(p)}});const q=document.querySelector(".order-buymp"),L=document.querySelector(".order-sellmp"),$=(s,p,m)=>{const f=p.toLocaleString("en-US"),M={title:"Xác nhận",body:`${s==="BUY"?"Mua":"Bán"} MP ${f} cổ phiếu ${m}?`,callback:async ae=>{if(ae){const oe=await ge(m,s,"MP",0,p);r.showNoticeDialog({title:"Thông báo",body:pe(oe.message)})}}};r.showConfirmDialog(M)},g=(s,p)=>{s.addEventListener("click",()=>{const m=parseFloat(y.value.replace(/,/g,"")),f=B();$(p,m,f)})};g(q,"BUY"),g(L,"SELL")}else{const u={title:"Luồng kết nối tới CTCK đã hết hạn",body:"Bấm Yes để tiến hành kết nối lại!",callback:n=>{n&&H()}};e.checked=!1,r.showConfirmDialog(u)}}else{const l={title:"Đóng liên kết giao dịch",body:"Bạn có chắc không?",callback:d=>{d?(o.style.display="none",c.status="unactive",localStorage.setItem("tradingHandle",JSON.stringify(c))):e.checked=!0}};r.showConfirmDialog(l)}})}),k.value.onChartReady(()=>{k.value.activeChart().onSymbolChanged().subscribe(null,t=>{const e=t.ticker;Y("update:symbol",e),ee(e)})}),(J=window.frames[0])==null||J.focus()};return ve(()=>{ne(O.value)}),V(_,(v,r)=>{r&&w.value.unsubscribeBars(r)}),V(D,v=>{k.value.changeTheme(v)}),G({updateSymbol:te}),(v,r)=>(he(),be("div",{ref_key:"finsc_chart",ref:O,class:"trader w-full h-full"},null,512))}};export{xe as default};
